<div class="page-header">
  <h1> Daily food intake planner</h1>
</div>

<% if not flash[:errors].blank? %>
    <% for error in flash[:errors] %>
        <div class="alert alert-danger"><%= error %></div>
    <% end %>
<% end %>

<% if not flash[:message].blank? %>
    <div class="alert alert-success"><%= flash[:message] %></div>
<% end %>


<%= form_for daily_food_planner_plan_path, method: 'POST' do %>
    <div id="user_input">

      <div class="input-group">
        <span class="input-group-addon" id="basic-addon1">Enter your weight, lbs:</span>
        <input type="number" name="weight" value="<%= @weight %>" class="form-control" placeholder="i.e. 185" aria-describedby="basic-addon1">
      </div>

      <br>

      <div class="panel panel-primary" style="text-align: center">
        <div class="panel-heading"> Enter nutrient targets</div>

        <div class="panel-body" style="text-align: left">

          <div class="input-group">
            <span class="input-group-addon" id="basic-addon1">Proteins, grams/kilo</span>
            <input type="number" name="target_prots_per_kilo" value="<%= @target_prots_per_kilo %>" class="form-control" placeholder="1 - 3" aria-describedby="basic-addon1">
          </div>
          <br>

          <div class="input-group">
            <span class="input-group-addon" id="basic-addon1">Carbs, grams/kilo</span>
            <input type="number" name="target_carbs_per_kilo" value="<%= @target_carbs_per_kilo %>" class="form-control" placeholder="1 - 7" aria-describedby="basic-addon1">
          </div>
          <br>

          <div class="input-group">
            <span class="input-group-addon" id="basic-addon1">Fats, grams/kilo</span>
            <input type="number" name="target_fats_per_kilo" value="<%= @target_fats_per_kilo %>" class="form-control" placeholder="0.5 - 1" aria-describedby="basic-addon1">
          </div>
        </div>
      </div>
    </div>

    <div style="padding-top: 1em">
      <div class="panel panel-primary">
        <div class="panel-heading">
          Select ingredients you will use today for cooking
        </div>

        <div class="panel-body" style="text-align: left">
          <% for i in 0..9 %>
              <% ingredients = Ingredient.all.order('name ASC') %>

              <% if  @quantities[i].nil? then
                   select_css = ' hidden';
                 else
                   select_css = ''
                 end %>
              <% if i == 0 then
                   select_css = ''
                 end %>

              <div style="margin-top: 1em; text-decoration: none">
                <select name="ingredient<%= i %>" class="select<%= select_css %>">
                  <option value="0">Choose ...</option>

                  <% for ingredient in ingredients %>
                      <% if ingredient.name == @ingredient_name[i] %>
                          <option value="<%= ingredient.name %>" selected>
                            <%= ingredient.name %> (<%= ingredient.units %>)
                          </option>
                      <% else %>
                          <option value="<%= ingredient.name %>">
                            <%= ingredient.name %> (<%= ingredient.units %>)
                          </option>
                      <% end %>
                  <% end %>
                </select>

                <input type="number" class="quantity<%= select_css %>" name="quantity<%= i %>" value="<%= @quantities[i] %>" placeholder="Enter quantity">

              </div>
          <% end %>

          <div>
            <input type="button" id="add_ingredient_button" class="btn btn-default btn-lg" name="add_ingredient_button" value="+">
          </div>

        </div>
      </div>
    </div>

    <%= submit_tag 'Submit', class: "btn btn-primary btn-lg" %>
<% end %>


<% if flash[:errors].blank? and @totals and @target %>
    <%
       overdose_progress_bar_css = 'progress-bar-striped active'
       overdose_label_css = 'color: red; font-weight: bold; font-size: larger'
    %>


    <div>
      <h2>Totals by nutrient:</h2>

      <% percent_prots = @totals[:prots]*100/@target[:prots] %>
      <% if percent_prots > 100
           prots_pb_css = overdose_progress_bar_css
           prots_pb_label_css = overdose_label_css
         end %>

      <div class="progress">
        <div class="progress-bar progress-bar-info <%= prots_pb_css %>" role="progressbar" style="width: <%= percent_prots%>%; min-width: 2em">
          <span style="<%= prots_pb_label_css %>"> <%= percent_prots&.round(0) %>%</span>
        </div>
      </div>

      <% percent_carbs = @totals[:carbs]*100/@target[:carbs] %>
      <% if percent_carbs > 100
           carbs_pb_css = overdose_progress_bar_css
           carbs_pb_label_css = overdose_label_css
         end %>

      <div class="progress">
        <div class="progress-bar progress-bar-success <%= carbs_pb_css %> " role="progressbar" style="width: <%= percent_carbs%>%; min-width: 2em">
          <span style="<%= carbs_pb_label_css %>"> <%= percent_carbs&.round(0) %>%</span>
        </div>
      </div>

      <% percent_fats = @totals[:fats]*100/@target[:fats] %>
      <% if percent_fats > 100
           fats_pb_css = overdose_progress_bar_css
           fats_pb_label_css = overdose_label_css
         end %>

      <div class="progress">
        <div class="progress-bar progress-bar-warning <%= fats_pb_css %> " role="progressbar" style="width: <%= percent_fats%>%; min-width: 2em">
          <span style="<%= fats_pb_label_css %>"> <%= percent_fats&.round(0) %>%</span>
        </div>
      </div>

    </div>
<% end %>

<script>
  $(function () {

    $("input[name='add_ingredient_button']").on('click', function () {
      var visible_selects_count = $("select[class='select']").length;
      var index_of_the_last_visible_field = visible_selects_count - 1;
      var last_quantity_name = 'quantity' + index_of_the_last_visible_field.toString();
      var last_quantity_value = $("input[name=" + last_quantity_name + "]").val();

      if (last_quantity_value != '') {
        var select_name = 'ingredient' + visible_selects_count.toString();
        var input_name = 'quantity' + visible_selects_count.toString();

        $("select[name=" + select_name + "]").removeClass('hidden');
        $("input[name=" + input_name + "]").removeClass('hidden');
      }
    })
  });
</script>